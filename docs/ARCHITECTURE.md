# Auto Diagram Generator (ADG) アーキテクチャドキュメント

*バージョン: v1.0.0*
*最終更新: 2025年01月16日 16:35 JST*

## 目次

1. [システム概要](#システム概要)
2. [アーキテクチャ原則](#アーキテクチャ原則)
3. [システム構成](#システム構成)
4. [コンポーネント詳細](#コンポーネント詳細)
5. [データフロー](#データフロー)
6. [技術スタック](#技術スタック)
7. [拡張性設計](#拡張性設計)
8. [パフォーマンス設計](#パフォーマンス設計)
9. [セキュリティ設計](#セキュリティ設計)

## システム概要

Auto Diagram Generator (ADG) は、ソースコードを解析して各種技術ドキュメント図を自動生成するPythonベースのツールです。プラグイン可能なアーキテクチャを採用し、複数の言語と図形式をサポートします。

### アーキテクチャスタイル

- **レイヤードアーキテクチャ**: 明確な責任分離
- **パイプライン＆フィルター**: データ処理の流れ
- **プラグインアーキテクチャ**: 拡張可能な設計

## アーキテクチャ原則

### 1. 単一責任の原則 (SRP)
各コンポーネントは単一の責任を持ち、明確に定義された役割を果たします。

### 2. 開放/閉鎖の原則 (OCP)
新しい言語や図形式の追加は、既存コードの変更なしに拡張として実装できます。

### 3. 依存性逆転の原則 (DIP)
高レベルモジュールは低レベルモジュールに依存せず、両方が抽象に依存します。

### 4. インターフェース分離の原則 (ISP)
クライアントは使用しないメソッドへの依存を強制されません。

## システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                         CLI Layer                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ analyze  │  │ generate │  │list-types│  │  config  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Core Logic Layer                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Analyzer   │  │  Detector   │  │  Generator  │        │
│  │   Engine    │  │   Engine    │  │  Controller │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Language Parsers Layer                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Python  │  │JavaScript│  │   Java   │  │   SQL    │  │
│  │  Parser  │  │  Parser  │  │  Parser  │  │  Parser  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Diagram Generators Layer                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Mermaid  │  │PlantUML  │  │ Draw.io  │  │ GraphViz │  │
│  │Generator │  │Generator │  │Generator │  │Generator │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Utility Layer                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Cache   │  │  Logger  │  │ Version  │  │Validation│  │
│  │ Manager  │  │  System  │  │ Manager  │  │  Utils   │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### CLI Layer

#### コマンドプロセッサー
- **責任**: ユーザー入力の処理とコマンドのルーティング
- **技術**: Click framework
- **インターフェース**: コマンドライン引数とオプション

```python
# コマンド構造
adg/
├── analyze     # 解析コマンド
├── generate    # 生成コマンド
└── list-types  # 図種別一覧コマンド
```

### Core Logic Layer

#### Analyzer Engine
- **責任**: プロジェクト全体の解析オーケストレーション
- **主要クラス**: ProjectAnalyzer
- **処理フロー**:
  1. ファイル探索
  2. 言語判定
  3. パーサー選択
  4. 解析実行
  5. 結果集約

#### Detector Engine
- **責任**: 必要な図の自動判定
- **主要クラス**: DiagramDetector
- **判定基準**:
  - コード構造の複雑度
  - クラス/関数の数
  - 依存関係の密度
  - 特定パターンの検出

#### Generator Controller
- **責任**: 図生成の制御と調整
- **主要機能**:
  - 生成順序の最適化
  - 並列処理の管理
  - エラーハンドリング
  - 進捗管理

### Language Parsers Layer

#### Python Parser
- **技術**: AST (Abstract Syntax Tree)
- **対応要素**:
  - クラス定義
  - 関数/メソッド
  - インポート文
  - デコレーター
  - 型ヒント

#### JavaScript Parser (将来実装)
- **技術**: tree-sitter
- **対応要素**:
  - ES6+ クラス
  - 関数定義
  - モジュールシステム
  - React/Vue コンポーネント

### Diagram Generators Layer

#### Mermaid Generator
- **出力形式**: Mermaid記法のマークダウン
- **対応図種**:
  - クラス図
  - ER図
  - シーケンス図
  - フローチャート

#### PlantUML Generator (将来実装)
- **出力形式**: PlantUML記法
- **特徴**: より詳細な図の表現が可能

### Utility Layer

#### Cache Manager
- **技術**: diskcache
- **キャッシュ戦略**:
  - ファイルハッシュベース
  - TTL: 24時間
  - LRU eviction

#### Logger System
- **技術**: loguru
- **ログレベル**:
  - DEBUG: 詳細なデバッグ情報
  - INFO: 一般的な情報
  - WARNING: 警告
  - ERROR: エラー
  - CRITICAL: 致命的エラー

## データフロー

### 解析フロー

```
入力ファイル
    ↓
[ファイル読み込み]
    ↓
[言語判定]
    ↓
[パーサー選択]
    ↓
[構文解析]
    ↓
[構造抽出]
    ↓
[メタデータ付与]
    ↓
解析結果オブジェクト
```

### 図生成フロー

```
解析結果
    ↓
[図種別判定]
    ↓
[優先度計算]
    ↓
[ジェネレーター選択]
    ↓
[図データ構築]
    ↓
[レイアウト計算]
    ↓
[フォーマット変換]
    ↓
出力ファイル
```

## 技術スタック

### コア技術

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| 言語 | Python | 3.9+ | メイン開発言語 |
| CLI | Click | 8.1.0+ | コマンドライン処理 |
| 設定 | PyYAML | 6.0+ | 設定ファイル管理 |
| UI | Rich | 13.0.0+ | ターミナルUI |

### 解析技術

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| Python解析 | ast | Python構文解析 |
| 汎用解析 | tree-sitter | 多言語対応 |
| コード分析 | astroid | 高度な静的解析 |
| 構文ハイライト | pygments | コード表示 |

### 図生成技術

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| グラフ描画 | graphviz | 基本的なグラフ生成 |
| Mermaid | mermaid-cli | Mermaid図の生成 |
| PlantUML | plantuml | UML図の生成 |

### ユーティリティ

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| ログ | loguru | ロギング |
| キャッシュ | diskcache | ディスクキャッシュ |
| 時刻 | pytz | タイムゾーン管理 |
| 環境変数 | python-dotenv | 環境設定 |

## 拡張性設計

### プラグインシステム

```python
# プラグインインターフェース
class ADGPlugin(ABC):
    @abstractmethod
    def initialize(self, config: Dict[str, Any]):
        """プラグイン初期化"""
        pass
    
    @abstractmethod
    def execute(self, context: PluginContext):
        """プラグイン実行"""
        pass
```

### 言語パーサーの追加

```python
# 新しい言語パーサーの実装例
class RustAnalyzer(CodeAnalyzer):
    def analyze(self) -> Dict[str, Any]:
        # Rust固有の解析ロジック
        return self._parse_rust_code()
```

### 図形式の追加

```python
# 新しい図形式の追加例
class D2Generator(DiagramGenerator):
    def generate(self, diagram_type: str) -> str:
        # D2形式での図生成
        return self._create_d2_diagram()
```

## パフォーマンス設計

### 並列処理

```python
# ファイル解析の並列化
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [executor.submit(analyze_file, path) 
               for path in file_paths]
    results = [f.result() for f in futures]
```

### キャッシング戦略

1. **ファイルレベルキャッシュ**
   - ファイルハッシュによるキャッシュキー
   - 変更がない場合は再解析をスキップ

2. **プロジェクトレベルキャッシュ**
   - 依存関係グラフのキャッシュ
   - インクリメンタル更新

### メモリ最適化

- ストリーミング処理による大規模ファイル対応
- 遅延評価による必要時のみのデータロード
- 弱参照を使用したメモリリークの防止

## セキュリティ設計

### 入力検証

```python
# ファイルパスの検証
def validate_path(path: str) -> bool:
    """パストラバーサル攻撃を防ぐ"""
    resolved = Path(path).resolve()
    base = Path.cwd().resolve()
    return resolved.is_relative_to(base)
```

### サンドボックス実行

- 外部コマンドの実行は制限
- ファイルシステムアクセスは指定ディレクトリのみ
- ネットワークアクセスなし（ローカル実行のみ）

### エラーハンドリング

```python
# セキュアなエラーハンドリング
try:
    result = analyze_code(file_path)
except Exception as e:
    # 内部エラー情報を隠蔽
    logger.error(f"Analysis failed: {e}")
    return {"error": "Analysis failed", "code": "ANALYSIS_ERROR"}
```

## 将来の拡張計画

### フェーズ1（短期）
- JavaScript/TypeScript サポート
- PlantUML生成器の実装
- 基本的なキャッシュシステム

### フェーズ2（中期）
- Java/C# サポート
- Draw.io生成器
- プラグインシステムの実装
- Web UIの追加

### フェーズ3（長期）
- AI統合（Claude API）
- リアルタイム協調編集
- クラウドサービス化
- IDE統合

---

*最終更新: 2025年01月16日 16:35 JST*
*バージョン: v1.0.0*

**更新履歴:**
- v1.0.0 (2025年01月16日): 初版作成、包括的なアーキテクチャ設計を文書化